"use strict";const e=/\/items\/([^-]+)\/([^-?]+)/;var t=({init:t},{services:n,database:i,getSchema:c,logger:r})=>{const{ItemsService:o}=n;async function s(t,n,s){if("PATCH"!==t.method||!t.body)return s();if(!e.test(t.url))return s();const{collection:a,id:l}=function(t){const n=t.match(e);return{collection:n[1],id:n[2]}}(t.url),d=new o(a,{knex:i,schema:await c(),accountability:t.accountability}),f=[];for(const[e,n]of Object.entries(t.body))if("string"==typeof n&&n.startsWith("increment(")){const t=n.replace("increment(","").replace(")","").replace(",",""),i=t.includes(".")?parseFloat(t):parseInt(t);f.push({field:e,inc:i})}const u=await d.readOne(l,{fields:f.map((({field:e})=>e))});for(const{field:e,inc:n}of f)t.body.hasOwnProperty(e)&&u.hasOwnProperty(e)&&(r.debug(`incremented field ${a}.${e} by ${n}`),t.body[e]=u[e]+n);s()}t("middlewares.after",(({app:e})=>e.use(s)))};module.exports=t;
